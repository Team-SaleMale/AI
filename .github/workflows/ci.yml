name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: cicd-ai-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/salemale-ai:latest
          ${{ secrets.DOCKER_USERNAME }}/salemale-ai:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2 (FastAPI with Docker Compose)
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e

          # 디렉토리 준비
          mkdir -p /home/ubuntu/salemale/AI
          cd /home/ubuntu/salemale/AI

          # Git 저장소 준비
          if [ ! -d .git ]; then
            git clone https://github.com/${{ github.repository }}.git .
          fi
          git fetch --all --prune
          git checkout main || git checkout -b main origin/main
          git reset --hard origin/main

          # .env 파일 생성
          cat > .env << EOF
          # FastAPI Runtime
          UVICORN_WORKERS=2
          UVICORN_HOST=0.0.0.0
          UVICORN_PORT=8000

          # Database Configuration
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT || '5432' }}
          DB_NAME=${{ secrets.DB_NAME }}

          # Hugging Face
          HF_SPACE_ID=${{ secrets.HF_SPACE_ID }}
          HF_API_TOKEN=${{ secrets.HF_API_TOKEN }}

          # AWS S3
          S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
          S3_REGION=${{ secrets.AWS_S3_REGION }}
          AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}

          # Docker Hub
          DOCKERHUB_USERNAME=${{ secrets.DOCKER_USERNAME }}
          EOF

          # Docker Compose v2/v1 자동 감지
          if docker compose version >/dev/null 2>&1; then
            DC="docker compose"
            WAIT_FLAG="--wait"
          else
            DC="docker-compose"
            WAIT_FLAG=""
          fi

          # 네트워크 확인 및 생성
          if ! docker network inspect salemale-network >/dev/null 2>&1; then
            echo "Creating salemale-network..."
            docker network create salemale-network || true
          fi

          # 프로젝트명 고정
          export COMPOSE_PROJECT_NAME=salemale-ai

          # 기존 컨테이너 정리
          echo "기존 컨테이너 정리 중..."
          $DC down --remove-orphans || true
          docker rm -f salemale-ai >/dev/null 2>&1 || true

          # 최신 이미지 pull
          echo "최신 이미지 pull 중..."
          docker pull ${{ secrets.DOCKER_USERNAME }}/salemale-ai:latest

          # 서비스 재기동
          echo "서비스 재기동 중..."
          $DC up -d --force-recreate --remove-orphans $WAIT_FLAG

          # 배포 상태 확인
          sleep 10
          echo "컨테이너 상태:"
          $DC ps
          
          # 헬스체크
          echo "AI 서버 헬스체크..."
          sleep 5
          curl -f http://localhost:8000/ || echo "⚠️ 헬스체크 실패, 하지만 계속 진행..."
          
          echo "✅ AI 서버 배포 완료!"